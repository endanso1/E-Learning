<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin â€“ Quiz Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background-color: #0c1d3c;
      color: #fff;
      font-family: "Segoe UI", sans-serif;
    }
    .btn-primary {
      background-color: #ffd700;
      color: #0c1d3c;
      border: none;
    }
    .form-section {
      background-color: #122850;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    @media (max-width: 576px) {
      h2.text-warning { font-size: 1.4rem; text-align: center; }
      .btn-lg { width: 100%; font-size: 1rem; padding: 0.75rem 1.25rem; }
    }
  </style>
</head>
<body>
  <a href="index.html" class="btn btn-primary btn-lg mt-4 mx-3 mb-3 px-5">Logout</a>

  <div class="container py-5">
    <h2 class="text-warning mb-4">ğŸ› ï¸ Quiz Manager</h2>

    <!-- Quiz Form -->
    <div class="form-section">
      <form id="questionForm">
        <div class="mb-3">
          <label for="courseId" class="form-label">Course ID</label>
          <input type="text" class="form-control" id="courseId" required />
        </div>
        <div class="mb-3">
          <label for="questionText" class="form-label">Question</label>
          <input type="text" class="form-control" id="questionText" required />
        </div>
        <div class="mb-3">
          <label for="options" class="form-label">Options (comma-separated)</label>
          <input type="text" class="form-control" id="options" required />
        </div>
        <div class="mb-3">
          <label for="answer" class="form-label">Correct Answer</label>
          <input type="text" class="form-control" id="answer" required />
        </div>
        <div class="mb-3">
          <label for="explanation" class="form-label">Explanation</label>
          <textarea class="form-control" id="explanation" rows="2" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">â• Add Question</button>
      </form>
    </div>

    <!-- Display Questions -->
    <h4 class="text-warning">ğŸ“‹ Course Questions</h4>
    <div id="questionList"></div>

    <!-- Display Results -->
    <h4 class="text-warning mt-5">ğŸ§‘â€ğŸ“ Student Quiz Results</h4>
    <div id="resultsList"></div>
  </div>

  <!-- Firebase & Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, query 
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // âœ… Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCd6BwNWOJ5T61t90Q5n-r66ljlNgoLhSs",
      authDomain: "lms-platform-944d6.firebaseapp.com",
      projectId: "lms-platform-944d6",
      storageBucket: "lms-platform-944d6.appspot.com",
      messagingSenderId: "273204688964",
      appId: "1:273204688964:web:3373974c9c61fac3872411"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ğŸ”’ Protect page with Role Check
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "admin-login.html"; 
        return;
      }
      const snap = await getDoc(doc(db, "users", user.uid));
      if (!snap.exists() || snap.data().role !== "admin") {
        alert("Access denied. Admins only.");
        window.location.href = "login.html";
      }
    });

    // ğŸ” Load Questions
    async function loadQuestions() {
      const questionList = document.getElementById("questionList");
      questionList.innerHTML = "<p class='text-info'>â³ Loading questions...</p>";
      const snapshot = await getDocs(query(collection(db, "questions")));
      const grouped = {};
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (!grouped[data.courseId]) grouped[data.courseId] = [];
        grouped[data.courseId].push({ ...data, id: docSnap.id });
      });
      questionList.innerHTML = "";
      for (let courseId in grouped) {
        const block = document.createElement("div");
        block.innerHTML = `<h5 class="text-info">ğŸ“˜ Course ${courseId}</h5>`;
        grouped[courseId].forEach((q, i) => {
          block.innerHTML += `
            <div class='mb-2'>
              <p><strong>Q${i+1}:</strong> ${q.question}<br>
              <small class='text-muted'>Answer: ${q.answer}</small></p>
              <button class='btn btn-sm btn-danger' onclick='deleteQuestion("${q.id}")'>ğŸ—‘ Delete</button>
            </div>`;
        });
        questionList.appendChild(block);
      }
    }

    // ğŸ§½ Delete Question
    window.deleteQuestion = async function(id) {
      await deleteDoc(doc(db, "questions", id));
      alert("âŒ Question deleted.");
      loadQuestions();
    };

    // â• Add Question
    const form = document.getElementById("questionForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const courseId = document.getElementById("courseId").value.trim();
      const question = document.getElementById("questionText").value.trim();
      const options = document.getElementById("options").value.trim().split(",").map(o=>o.trim());
      const answer = document.getElementById("answer").value.trim();
      const explanation = document.getElementById("explanation").value.trim();
      if (!courseId || !question || options.length < 2 || !answer) {
        alert("âš ï¸ Please fill all fields properly.");
        return;
      }
      await addDoc(collection(db, "questions"), { courseId, question, options, answer, explanation });
      alert("âœ… Question added successfully!");
      form.reset();
      loadQuestions();
    });

    // ğŸ“Š Load Results
    async function loadResults() {
      const resultsDiv = document.getElementById("resultsList");
      resultsDiv.innerHTML = "";
      const snapshot = await getDocs(collection(db, "results"));
      if (snapshot.empty) {
        resultsDiv.innerHTML = "<p class='text-muted'>No quiz results submitted yet.</p>";
        return;
      }
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        resultsDiv.innerHTML += `
          <div class="mb-3 p-3 bg-dark rounded">
            <strong>Name:</strong> ${data.name}<br/>
            <strong>Index No.:</strong> ${data.index}<br/>
            <strong>Course:</strong> ${data.courseId}<br/>
            <strong>Score:</strong> ${data.score}/${data.total}<br/>
            <strong>Submitted:</strong> ${new Date(data.timestamp).toLocaleString()}
          </div>`;
      });
    }

    // ğŸš€ Init
    loadQuestions();
    loadResults();
  </script>
</body>
</html>
